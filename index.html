<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vocalo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #09090b; --main: #fafafa; --sub: #71717a;
            --acc: #4ade80; --err: #f43f5e; --card-bg: #18181b;
            --success: #22c55e; --warning: #f59e0b;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }
        [data-theme="light"] { 
            --bg: #ffffff; --main: #09090b; --sub: #71717a; 
            --acc: #16a34a; --err: #dc2626; --card-bg: #f4f4f5; 
            --border: rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        [data-theme="nord"] { --bg: #2e3440; --main: #eceff4; --sub: #4c566a; --acc: #88c0d0; --err: #bf616a; --card-bg: #3b4252; }
        [data-theme="dracula"] { --bg: #282a36; --main: #f8f8f2; --sub: #6272a4; --acc: #bd93f9; --err: #ff5555; --card-bg: #44475a; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: var(--bg); color: var(--main); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            min-height: 100vh; 
            transition: background 0.3s, color 0.3s;
            line-height: 1.5;
        }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.5rem 2rem; border-bottom: 1px solid var(--border);
            max-width: 1200px; margin: 0 auto;
        }
        .logo { font-weight: 800; font-size: 1.5rem; letter-spacing: -0.05em; }
        .logo span { color: var(--acc); }

        .nav { display: flex; gap: 0.5rem; background: var(--card-bg); padding: 0.25rem; border-radius: 12px; border: 1px solid var(--border); }
        .nav-btn {
            background: transparent; border: none;
            color: var(--sub); padding: 0.5rem 1rem; border-radius: 8px;
            cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;
        }
        .nav-btn:hover { color: var(--main); }
        .nav-btn.active { background: var(--bg); color: var(--main); box-shadow: var(--shadow); }

        .controls { display: flex; gap: 0.75rem; align-items: center; }
        .select-wrap select {
            background: var(--card-bg); border: 1px solid var(--border);
            color: var(--main); padding: 0.5rem 1rem; border-radius: 8px;
            cursor: pointer; font-size: 0.875rem; transition: 0.2s;
        }
        .select-wrap select:hover { border-color: var(--sub); }

        .icon-btn {
            background: var(--card-bg); border: 1px solid var(--border); color: var(--sub);
            cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { color: var(--acc); border-color: var(--acc); }

        .main { max-width: 900px; margin: 0 auto; padding: 3rem 1.5rem; }

        .deck-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2.5rem; flex-wrap: wrap; gap: 1rem;
        }
        .deck-select {
            background: var(--card-bg); border: 1px solid var(--border);
            color: var(--main); padding: 0.75rem 1.25rem; border-radius: 10px;
            font-size: 0.95rem; font-weight: 500; min-width: 220px; cursor: pointer;
            transition: 0.2s;
        }
        .deck-select:hover { border-color: var(--sub); }

        .deck-stats {
            display: flex; gap: 1.25rem; color: var(--sub); font-size: 0.825rem;
            font-weight: 500;
        }
        .deck-stats span { display: flex; align-items: center; gap: 0.5rem; }
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot.new { background: var(--acc); }
        .dot.learning { background: var(--warning); }
        .dot.mastered { background: var(--success); }

        /* Flashcard */
        .card-container {
            perspective: 1000px; margin: 2rem 0;
        }
        .flashcard {
            width: 100%; min-height: 360px; position: relative;
            transform-style: preserve-3d; 
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
        }
        .flashcard.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 24px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 3rem; background: var(--card-bg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

		.flashcard.changing .card-face {
		    opacity: 0;
            transition: opacity 0.2s;
		}
        
        .card-back { transform: rotateY(180deg); }

        .card-label {
            position: absolute; top: 1.5rem; left: 1.5rem;
            font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 0.1em; color: var(--sub); font-weight: 700;
        }
        .card-word {
            font-size: 3rem; font-weight: 700; text-align: center;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -0.02em;
        }
        .card-hint {
            margin-top: 1.5rem; color: var(--sub); font-size: 0.9rem;
            font-weight: 500;
        }
        .card-example {
            margin-top: 1.5rem; color: var(--sub); font-size: 1rem;
            max-width: 450px; text-align: center; line-height: 1.6;
        }

        .card-actions {
            display: flex; gap: 1rem; justify-content: center; margin-top: 2.5rem;
        }
        .action-btn {
            padding: 0.75rem 1.75rem;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--main);
            transition: all 0.2s;
        }
        
        .action-btn.again:hover { border-color: var(--err); color: var(--err); background: rgba(244, 63, 94, 0.1); }
        .action-btn.hard:hover  { border-color: var(--warning); color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        .action-btn.good:hover  { border-color: var(--acc); color: var(--acc); background: rgba(74, 222, 128, 0.1); }
        .action-btn.easy:hover  { border-color: var(--success); color: var(--success); background: rgba(34, 197, 94, 0.1); }
        
        .flip-hint {
            text-align: center; color: var(--sub); font-size: 0.8rem;
            margin-top: 2rem; font-weight: 500;
        }
        .key { 
            background: var(--card-bg); border: 1px solid var(--border); padding: 2px 6px; 
            border-radius: 6px; font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem; color: var(--main);
        }

        /* Type Mode */
        .type-container { text-align: center; }
        .prompt-card {
            background: var(--card-bg); border-radius: 24px;
            padding: 4rem 2rem; margin-bottom: 2.5rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .prompt-label {
            font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 0.1em; color: var(--sub); margin-bottom: 1.5rem; font-weight: 700;
        }
        .prompt-text {
            font-size: 2.25rem; font-weight: 700; line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .type-input-wrap {
            position: relative; max-width: 500px; margin: 0 auto;
        }
        .type-input {
            width: 100%; padding: 1.25rem 1.5rem; font-size: 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 16px; color: var(--main);
            text-align: center; outline: none; transition: 0.2s;
            box-shadow: var(--shadow);
        }
        .type-input:focus { border-color: var(--acc); }
        .type-input.correct { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }
        .type-input.incorrect { border-color: var(--err); background: rgba(244, 63, 94, 0.05); }

        .type-feedback {
            margin-top: 1.5rem; font-size: 1rem; min-height: 1.5rem; font-weight: 600;
        }
        .type-feedback.correct { color: var(--success); }
        .type-feedback.incorrect { color: var(--err); }

        .correct-answer {
            margin-top: 1rem; padding: 1rem 1.5rem;
            background: rgba(128,128,128,0.05); border-radius: 12px;
            font-family: 'JetBrains Mono', monospace; font-size: 1.1rem;
            color: var(--acc);
        }

        .score-display {
            display: flex; justify-content: center; gap: 3rem;
            margin-bottom: 2.5rem;
        }
        .score-item { text-align: center; }
        .score-val { font-size: 1.75rem; font-weight: 800; color: var(--main); line-height: 1; }
        .score-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--sub); margin-top: 0.5rem; font-weight: 700; }

        /* Progress bar */
        .progress-bar {
            height: 6px; background: var(--card-bg);
            border-radius: 10px; margin-bottom: 2.5rem; overflow: hidden;
            border: 1px solid var(--border);
        }
        .progress-fill {
            height: 100%; background: var(--acc);
            transition: width 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* Completion Screen */
        .complete-screen {
            text-align: center; padding: 2rem 0;
        }
        .complete-icon { font-size: 4rem; margin-bottom: 1.5rem; }
        .complete-title { font-size: 2.25rem; font-weight: 800; margin-bottom: 0.5rem; letter-spacing: -0.02em; }
        .complete-subtitle { color: var(--sub); margin-bottom: 3rem; font-weight: 500; }
        .complete-stats {
            display: flex; justify-content: center; gap: 3rem; margin-bottom: 3rem;
            background: var(--card-bg); padding: 2rem; border-radius: 24px; border: 1px solid var(--border);
        }

        .error-list {
            margin: 3rem 0; text-align: left;
        }
        .error-list h4 { margin-bottom: 1.5rem; font-size: 1.1rem; color: var(--sub); text-transform: uppercase; letter-spacing: 0.05em; }
        .error-item {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
            padding: 1rem; background: var(--card-bg); border-radius: 12px;
            margin-bottom: 0.75rem; border: 1px solid var(--border);
        }
        .error-word { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--err); }
        .error-trans { color: var(--sub); font-size: 0.9rem; }

        .manager { padding: 3rem 1.5rem; max-width: 900px; margin: 0 auto; }
        .manager h2 { font-size: 1.75rem; font-weight: 800; margin-bottom: 2rem; letter-spacing: -0.02em; }

        .deck-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem; margin-bottom: 4rem;
        }
        .deck-card {
            background: var(--card-bg); border-radius: 20px; padding: 1.75rem;
            border: 1px solid var(--border); cursor: pointer;
            transition: all 0.2s; box-shadow: var(--shadow);
        }
        .deck-card:hover { border-color: var(--acc); transform: translateY(-4px); }
        .deck-card h3 { font-size: 1.25rem; margin-bottom: 0.5rem; }
        .deck-card .meta { color: var(--sub); font-size: 0.85rem; font-weight: 500; }

        .add-deck-card {
            border: 2px dashed var(--border); display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            color: var(--sub); min-height: 140px; background: transparent;
        }
        .add-deck-card:hover { border-color: var(--acc); color: var(--acc); background: rgba(74, 222, 128, 0.05); }

        /* Import/Export */
        .import-area {
            border: 2px dashed var(--border); border-radius: 20px;
            padding: 3rem; text-align: center; margin: 2rem 0;
            transition: all 0.2s; cursor: pointer;
            background: var(--card-bg);
        }
        .import-area:hover { border-color: var(--acc); background: rgba(74, 222, 128, 0.05); }
        .import-area p { color: var(--sub); font-weight: 500; }
        .import-area p:first-child { color: var(--main); font-size: 1.1rem; margin-bottom: 0.5rem; }

        .format-hint {
            background: var(--card-bg); padding: 2rem;
            border-radius: 20px; font-size: 0.85rem; color: var(--sub);
            margin-top: 2rem; font-family: 'JetBrains Mono', monospace;
            white-space: pre-line; text-align: left;
            border: 1px solid var(--border);
            line-height: 1.6;
        }
        .format-hint strong { color: var(--acc); }

        /* Modal refine */
        .editor-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .editor-overlay.show { opacity: 1; pointer-events: all; }

        .editor-modal {
            background: var(--bg); border-radius: 24px;
            width: 95%; max-width: 850px;
            max-height: 85vh; overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.6);
            transform: translateY(30px) scale(0.98);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        .editor-overlay.show .editor-modal { transform: translateY(0) scale(1); }

        .editor-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.5rem 2rem;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 10;
        }
        .editor-header h2 { font-size: 1.25rem; font-weight: 800; letter-spacing: -0.02em; }
        .editor-header .header-actions { display: flex; gap: 0.75rem; align-items: center; }

        .editor-content {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
        }

        .form-section {
            margin-bottom: 3rem;
        }
        .form-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group { margin-bottom: 1.25rem; }
        .form-label {
            display: block; font-size: 0.7rem; color: var(--sub);
            text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.6rem; font-weight: 700;
        }
        .form-input {
            width: 100%; padding: 0.8rem 1.1rem; font-size: 0.95rem;
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 12px; color: var(--main); transition: all 0.2s;
        }
        .form-input:focus { outline: none; border-color: var(--acc); background: var(--bg); }

        .word-list-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .word-list-header h3 { font-size: 1rem; font-weight: 700; color: var(--sub); }

        .word-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .word-item {
            display: grid; grid-template-columns: 1fr 1fr 1fr 44px;
            gap: 0.75rem; padding: 0.75rem; background: var(--card-bg);
            border-radius: 14px; align-items: center;
            border: 1px solid var(--border);
            transition: 0.2s;
        }
        .word-item:focus-within { border-color: var(--sub); transform: translateX(4px); }
        .word-item input {
            padding: 0.6rem 0.9rem; background: var(--bg);
            border: 1px solid var(--border); border-radius: 10px;
            color: var(--main); font-size: 0.9rem; width: 100%;
            transition: 0.2s;
        }
        .word-item input:focus { border-color: var(--acc); outline: none; }
        
        .delete-word {
            height: 32px; width: 32px;
            background: transparent; border: none; color: var(--sub);
            cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; transition: all 0.2s;
        }
        .delete-word:hover { background: var(--err); color: #fff; }

        .editor-footer {
            padding: 1.5rem 2rem;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .btn {
            padding: 0.7rem 1.4rem; border-radius: 12px; font-size: 0.875rem;
            font-weight: 600; cursor: pointer; border: none; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary { background: var(--acc); color: #000; }
        .btn-secondary { background: var(--bg); border: 1px solid var(--border); color: var(--main); }
        .btn-danger { background: rgba(244, 63, 94, 0.1); color: var(--err); }
        .btn-danger:hover { background: var(--err); color: #fff; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(0); }

        /* Stats Modal */
        #statsOverlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #statsOverlay.show { opacity: 1; pointer-events: all; }

        .stats-modal {
            background: var(--bg); border-radius: 24px;
            width: 95%; max-width: 800px;
            max-height: 80vh; overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.6);
            transform: translateY(30px);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        #statsOverlay.show .stats-modal { transform: translateY(0); }

        .stats-header {
            padding: 1.5rem 2rem; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .stats-content {
            padding: 2rem; overflow-y: auto; flex: 1;
        }

        .stats-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;
            margin-bottom: 3rem;
        }
        .stat-card {
            background: var(--card-bg); padding: 1.5rem; border-radius: 20px;
            border: 1px solid var(--border); text-align: center;
        }
        .stat-card .val { font-size: 2rem; font-weight: 800; color: var(--acc); display: block; }
        .stat-card .label { font-size: 0.7rem; text-transform: uppercase; color: var(--sub); font-weight: 700; margin-top: 0.5rem; display: block; }

        .history-table {
            width: 100%; border-collapse: collapse;
        }
        .history-table th {
            text-align: left; padding: 1rem; color: var(--sub); font-size: 0.7rem;
            text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border);
        }
        .history-table td {
            padding: 1rem; border-bottom: 1px solid var(--border); font-size: 0.9rem;
        }
        .history-table tr:last-child td { border-bottom: none; }
        .mode-badge {
            padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;
            text-transform: uppercase; background: var(--card-bg); border: 1px solid var(--border);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--sub); }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">voca<span>lo</span></div>
        <div class="nav">
            <button class="nav-btn active" data-view="flashcard">Flashcards</button>
            <button class="nav-btn" data-view="type">Type Mode</button>
            <button class="nav-btn" data-view="decks">Manage Decks</button>
        </div>
        <div class="controls">
            <div class="select-wrap">
                <select id="themeSelect" onchange="setTheme(this.value)">
                    <option value="default">Dark</option>
                    <option value="light">Light</option>
                    <option value="nord">Nord</option>
                    <option value="dracula">Dracula</option>
                </select>
            </div>
            <button class="icon-btn" onclick="showStats()" title="Statistics">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Flashcard View -->
    <div class="main view-flashcard">
        <div class="deck-header">
            <select class="deck-select" id="deckSelect" onchange="loadDeck(this.value)"></select>
            <div class="deck-stats">
                <span><div class="dot new"></div> <span id="newCount">0</span></span>
                <span><div class="dot learning"></div> <span id="learningCount">0</span></span>
                <span><div class="dot mastered"></div> <span id="masteredCount">0</span></span>
            </div>
        </div>

        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>

        <div id="flashcardArea">
            <div class="card-container">
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="card-face card-front">
                        <div class="card-label" id="frontLabel">Word</div>
                        <div class="card-word" id="frontText"></div>
                        <div class="card-hint" id="frontHint"></div>
                    </div>
                    <div class="card-face card-back">
                        <div class="card-label" id="backLabel">Translation</div>
                        <div class="card-word" id="backText"></div>
                        <div class="card-example" id="exampleText"></div>
                    </div>
                </div>
            </div>

            <div class="flip-hint">Press <span class="key">Space</span> to flip ¬∑ <span class="key">1-4</span> to rate</div>

            <div class="card-actions" id="cardActions" style="display:none;">
                <button class="action-btn again" onclick="rateCard(0)">Again</button>
                <button class="action-btn hard" onclick="rateCard(1)">Hard</button>
                <button class="action-btn good" onclick="rateCard(2)">Good</button>
                <button class="action-btn easy" onclick="rateCard(3)">Easy</button>
            </div>
        </div>

        <div id="completeArea" class="complete-screen" style="display:none;">
            <div class="complete-icon">üéâ</div>
            <div class="complete-title">Session Complete</div>
            <div class="complete-subtitle">You've reviewed all cards in this deck</div>
            <div class="complete-stats">
                <div class="score-item"><div class="score-val" id="sessionCorrect">0</div><div class="score-label">Correct</div></div>
                <div class="score-item"><div class="score-val" id="sessionTotal">0</div><div class="score-label">Total</div></div>
                <div class="score-item"><div class="score-val" id="sessionAccuracy">0%</div><div class="score-label">Accuracy</div></div>
            </div>
            <div id="errorList" class="error-list" style="display:none;">
                <h4>Review Errors</h4>
                <div id="errorItems"></div>
            </div>
            <button class="btn btn-primary" onclick="restartSession()">Study Again</button>
        </div>
    </div>

    <!-- Type Mode View -->
    <div class="main view-type" style="display:none;">
        <div class="deck-header">
            <select class="deck-select" id="typeDeckSelect" onchange="loadDeck(this.value)"></select>
        </div>

        <div id="typeArea">
            <div class="score-display">
                <div class="score-item"><div class="score-val" id="typeScore">0</div><div class="score-label">Score</div></div>
                <div class="score-item"><div class="score-val" id="typeStreak">0</div><div class="score-label">Streak</div></div>
            </div>

            <div class="progress-bar"><div class="progress-fill" id="typeProgress" style="width:0%"></div></div>

            <div class="type-container">
                <div class="prompt-card">
                    <div class="prompt-label" id="typePromptLabel">Translation</div>
                    <div class="prompt-text" id="typePrompt"></div>
                </div>

                <div class="type-input-wrap">
                    <input type="text" class="type-input" id="typeInput" placeholder="Type the word..." autocomplete="off">
                </div>

                <div class="type-feedback" id="typeFeedback"></div>
                <div class="correct-answer" id="correctAnswer" style="display:none;"></div>

                <div style="margin-top:2rem;">
                    <button class="btn btn-primary" id="nextBtn" onclick="nextTypeCard()" style="display:none;">Next Word</button>
                </div>

                <div class="flip-hint" style="margin-top:2rem;">Press <span class="key">Enter</span> to check ¬∑ <span class="key">Enter</span> or <span class="key">Tab</span> for next</div>
            </div>
        </div>

        <div id="typeCompleteArea" class="complete-screen" style="display:none;">
            <div class="complete-icon">üèÜ</div>
            <div class="complete-title">Training Done!</div>
            <div class="complete-subtitle">Great progress in this session</div>
            <div class="complete-stats">
                <div class="score-item"><div class="score-val" id="typeSessionScore">0</div><div class="score-label">Final Score</div></div>
                <div class="score-item"><div class="score-val" id="typeSessionCorrect">0</div><div class="score-label">Correct</div></div>
                <div class="score-item"><div class="score-val" id="typeSessionAccuracy">0%</div><div class="score-label">Accuracy</div></div>
            </div>
            <div id="typeErrorList" class="error-list" style="display:none;">
                <h4>Missed Words</h4>
                <div id="typeErrorItems"></div>
            </div>
            <button class="btn btn-primary" onclick="restartSession()">Try Again</button>
        </div>
    </div>

    <!-- Deck Manager View -->
    <div class="manager view-decks" style="display:none;">
        <h2>Your Decks</h2>

        <div class="deck-grid" id="deckGrid"></div>

        <h2 style="margin-top:40px;">Import / Export</h2>
        <div class="import-area" id="importArea" onclick="document.getElementById('fileInput').click()">
            <p>Drop a file here or click to import</p>
            <p style="font-size:0.85rem;color:var(--sub);margin-top:10px;">Supports JSON and TSV formats</p>
        </div>
        <input type="file" id="fileInput" style="display:none" accept=".json,.tsv,.txt" onchange="handleFileImport(event)">

        <div class="format-hint">
<strong>JSON format:</strong>
{"name": "Spanish Basics", "words": [
  {"word": "hola", "translation": "hello", "definition": "greeting"},
  ...
]}

<strong>TSV format (tab-separated):</strong>
word    translation    definition (optional)
hola    hello          a greeting
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsOverlay" onclick="if(event.target===this)this.classList.remove('show')">
        <div class="stats-modal">
            <div class="stats-header">
                <h2 style="font-weight: 800; letter-spacing: -0.02em;">Learning Progress</h2>
                <button class="icon-btn" onclick="document.getElementById('statsOverlay').classList.remove('show')" style="padding: 0.6rem;">‚úï</button>
            </div>
            <div class="stats-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="val" id="totalReviewed">0</span>
                        <span class="label">Total Reviewed</span>
                    </div>
                    <div class="stat-card">
                        <span class="val" id="avgAccuracy">0%</span>
                        <span class="label">Avg. Accuracy</span>
                    </div>
                    <div class="stat-card">
                        <span class="val" id="totalScore">0</span>
                        <span class="label">Total Score</span>
                    </div>
                </div>

                <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em;">Recent Sessions</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Deck</th>
                            <th>Mode</th>
                            <th>Accuracy</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody id="sessionHistory"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Editor Modal -->
    <div class="editor-overlay" id="editorOverlay">
        <div class="editor-modal">
            <div class="editor-header">
                <h2 id="editorTitle">Edit Deck</h2>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportDeck()">Export</button>
                    <button class="btn btn-primary" onclick="saveDeck()">Save Changes</button>
                    <button class="icon-btn" onclick="closeEditor()" style="padding: 0.6rem;">‚úï</button>
                </div>
            </div>

            <div class="editor-content">
                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Deck Name</label>
                            <input type="text" class="form-input" id="deckName" placeholder="e.g., Spanish Basics">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="deckDesc" placeholder="e.g., Common Spanish words">
                        </div>
                    </div>
                </div>

                <div class="word-list-header">
                    <h3>Words & Translations</h3>
                    <button class="btn btn-secondary" onclick="addWordRow()" style="padding: 0.5rem 1rem; font-size: 0.8rem;">+ Add Word</button>
                </div>

                <div class="word-list" id="wordList"></div>
            </div>

            <div class="editor-footer">
                <button class="btn btn-danger" id="deleteBtn" onclick="deleteDeck()" style="display:none;">Delete Deck</button>
                <div style="color: var(--sub); font-size: 0.8rem; font-weight: 500;">
                    Tip: Use <span class="key" style="font-size: 0.7rem;">Tab</span> to navigate quickly
                </div>
            </div>
        </div>
    </div>

<script>
// ===== State =====
let decks = {};
let currentDeck = null;
let currentCards = [];
let cardIndex = 0;
let isFlipped = false;
let currentView = 'flashcard';

// Stats per session
let session = { correct: 0, total: 0, streak: 0, score: 0, missed: [] };

// Card progress (word -> {level: 0-3, lastSeen: timestamp})
let progress = JSON.parse(localStorage.getItem('vocabProgress') || '{}');

// ===== Theme =====
function setTheme(t) {
    document.documentElement.setAttribute('data-theme', t || 'default');
    localStorage.setItem('theme', t || 'default');
}
setTheme(localStorage.getItem('theme'));

// ===== View Navigation =====
document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        if (btn.classList.contains('active')) return;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentView = btn.dataset.view;
        document.querySelectorAll('.main, .manager').forEach(v => v.style.display = 'none');
        document.querySelector('.view-' + currentView).style.display = 'block';
        if (currentView === 'decks') renderDeckGrid();
        else startSession();
    });
});

// ===== Load Decks =====
async function loadDecks() {
    try {
        const res = await fetch('/api/decks');
        decks = await res.json();
    } catch { decks = {}; }

    populateDeckSelects();
    if (Object.keys(decks).length > 0) {
        loadDeck(Object.keys(decks)[0]);
    }
}

function populateDeckSelects() {
    const opts = Object.keys(decks).map(k => `<option value="${k}">${decks[k].name}</option>`).join('');
    document.getElementById('deckSelect').innerHTML = opts || '<option>No decks</option>';
    document.getElementById('typeDeckSelect').innerHTML = opts || '<option>No decks</option>';
}

function loadDeck(id) {
    if (!decks[id]) return;
    currentDeck = id;
    document.getElementById('deckSelect').value = id;
    document.getElementById('typeDeckSelect').value = id;
    startSession();
}

function startSession() {
    if (!currentDeck || !decks[currentDeck]) return;

    session = { correct: 0, total: 0, streak: 0, score: 0, missed: [] };
    currentCards = [...decks[currentDeck].words];
    shuffleArray(currentCards);
    cardIndex = 0;

    // Reset areas
    document.getElementById('flashcardArea').style.display = 'block';
    document.getElementById('completeArea').style.display = 'none';
    document.getElementById('typeArea').style.display = 'block';
    document.getElementById('typeCompleteArea').style.display = 'none';

    updateDeckStats();
    if (currentView === 'flashcard') showCard();
    if (currentView === 'type') showTypeCard();
}

function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
}

// ===== Flashcard Mode =====
function showCard() {
    if (cardIndex >= currentCards.length) {
        showComplete();
        return;
    }

    const card = currentCards[cardIndex];
    document.getElementById('frontText').textContent = card.word;
    document.getElementById('frontHint').textContent = card.hint || '';
    document.getElementById('backText').textContent = card.translation || card.definition || '';
    document.getElementById('exampleText').textContent = card.example || '';
    updateProgress();
}

function flipCard() {
    isFlipped = !isFlipped;
    document.getElementById('flashcard').classList.toggle('flipped', isFlipped);
    document.getElementById('cardActions').style.display = isFlipped ? 'flex' : 'none';
}

function rateCard(rating) {
    if (!isFlipped) return flipCard();

    const card = currentCards[cardIndex];
    const key = currentDeck + ':' + card.word;

    if (!progress[key]) progress[key] = { level: 0, lastSeen: 0 };
    progress[key].lastSeen = Date.now();

    if (rating >= 2) {
        progress[key].level = Math.min(3, progress[key].level + 1);
        session.correct++;
    } else {
        progress[key].level = Math.max(0, progress[key].level - 1);
        session.missed.push(card);
    }
    session.total++;
    localStorage.setItem('vocabProgress', JSON.stringify(progress));

    const el = document.getElementById('flashcard');
    isFlipped = false;
    el.classList.remove('flipped');
    el.classList.add('changing');
    document.getElementById('cardActions').style.display = 'none';

    setTimeout(() => {
        cardIndex++;
        showCard();
        updateDeckStats();
        el.classList.remove('changing');
    }, 300); 
}

function updateProgress() {
    const pct = currentCards.length ? ((cardIndex / currentCards.length) * 100) : 0;
    const bar = currentView === 'flashcard' ? 'progressFill' : 'typeProgress';
    document.getElementById(bar).style.width = pct + '%';
}

function updateDeckStats() {
    if (!currentDeck || !decks[currentDeck]) return;

    let newC = 0, learning = 0, mastered = 0;
    decks[currentDeck].words.forEach(w => {
        const key = currentDeck + ':' + w.word;
        const p = progress[key];
        if (!p) newC++;
        else if (p.level >= 3) mastered++;
        else learning++;
    });

    document.getElementById('newCount').textContent = newC;
    document.getElementById('learningCount').textContent = learning;
    document.getElementById('masteredCount').textContent = mastered;
}

function showComplete() {
    if (currentView === 'flashcard') {
        document.getElementById('flashcardArea').style.display = 'none';
        document.getElementById('completeArea').style.display = 'block';
        document.getElementById('sessionCorrect').textContent = session.correct;
        document.getElementById('sessionTotal').textContent = session.total;
        const acc = session.total ? Math.round((session.correct / session.total) * 100) : 0;
        document.getElementById('sessionAccuracy').textContent = acc + '%';
        renderErrors('errorList', 'errorItems');
    } else {
        document.getElementById('typeArea').style.display = 'none';
        document.getElementById('typeCompleteArea').style.display = 'block';
        document.getElementById('typeSessionScore').textContent = session.score;
        document.getElementById('typeSessionCorrect').textContent = session.correct;
        const acc = session.total ? Math.round((session.correct / session.total) * 100) : 0;
        document.getElementById('typeSessionAccuracy').textContent = acc + '%';
        renderErrors('typeErrorList', 'typeErrorItems');
    }
    saveSession();
}

function renderErrors(listId, itemsId) {
    const list = document.getElementById(listId);
    const items = document.getElementById(itemsId);
    if (session.missed.length === 0) {
        list.style.display = 'none';
        return;
    }
    list.style.display = 'block';
    items.innerHTML = session.missed.map(m => `
        <div class="error-item">
            <div class="error-word">${m.word}</div>
            <div class="error-trans">${m.translation || m.definition}</div>
        </div>
    `).join('');
}

function restartSession() { startSession(); }

async function saveSession() {
    try {
        await fetch('/api/save-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                deck: currentDeck,
                correct: session.correct,
                total: session.total,
                score: session.score,
                mode: currentView
            })
        });
    } catch {}
}

// ===== Type Mode =====
let typeCard = null;
let typeAnswered = false;

function showTypeCard() {
    if (cardIndex >= currentCards.length) {
        showComplete();
        return;
    }

    typeCard = currentCards[cardIndex];
    typeAnswered = false;

    document.getElementById('typePromptLabel').textContent = typeCard.translation ? 'Translation' : 'Definition';
    document.getElementById('typePrompt').textContent = typeCard.translation || typeCard.definition || '';

    const input = document.getElementById('typeInput');
    input.value = '';
    input.className = 'type-input';
    input.readOnly = false;
    input.focus();

    document.getElementById('typeFeedback').textContent = '';
    document.getElementById('typeFeedback').className = 'type-feedback';
    document.getElementById('correctAnswer').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'none';

    document.getElementById('typeScore').textContent = session.score;
    document.getElementById('typeStreak').textContent = session.streak;

    updateProgress();
}

function checkTypeAnswer() {
    if (typeAnswered || !typeCard) return;

    const input = document.getElementById('typeInput').value.trim().toLowerCase();
    const correct = typeCard.word.toLowerCase();
    typeAnswered = true;

    const key = currentDeck + ':' + typeCard.word;
    if (!progress[key]) progress[key] = { level: 0, lastSeen: 0 };
    progress[key].lastSeen = Date.now();

    const inputEl = document.getElementById('typeInput');
    const feedback = document.getElementById('typeFeedback');

    if (input === correct) {
        inputEl.classList.add('correct');
        feedback.textContent = '‚úì Correct!';
        feedback.className = 'type-feedback correct';
        progress[key].level = Math.min(3, progress[key].level + 1);
        session.correct++;
        session.streak++;
        session.score += 10 + (session.streak * 2);
    } else {
        inputEl.classList.add('incorrect');
        feedback.textContent = '‚úó Incorrect';
        feedback.className = 'type-feedback incorrect';
        document.getElementById('correctAnswer').textContent = 'Correct: ' + typeCard.word;
        document.getElementById('correctAnswer').style.display = 'block';
        progress[key].level = Math.max(0, progress[key].level - 1);
        session.streak = 0;
        session.missed.push(typeCard);
    }

    session.total++;
    inputEl.readOnly = true;
    document.getElementById('nextBtn').style.display = 'inline-block';
    document.getElementById('typeScore').textContent = session.score;
    document.getElementById('typeStreak').textContent = session.streak;

    localStorage.setItem('vocabProgress', JSON.stringify(progress));
}

function nextTypeCard() {
    cardIndex++;
    showTypeCard();
}

document.getElementById('typeInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
        if (!typeAnswered) checkTypeAnswer();
        else nextTypeCard();
    }
    if (e.key === 'Tab' && typeAnswered) {
        e.preventDefault();
        nextTypeCard();
    }
});

// ===== Deck Manager (rest of script unchanged) =====
let editingDeck = null;

function renderDeckGrid() {
    const grid = document.getElementById('deckGrid');
    let html = '';

    for (const [id, deck] of Object.entries(decks)) {
        html += `
            <div class="deck-card" onclick="openEditor('${id}')">
                <h3>${deck.name}</h3>
                <div class="meta">${deck.words.length} words ¬∑ ${deck.description || ''}</div>
            </div>
        `;
    }

    html += `<div class="deck-card add-deck-card" onclick="openEditor(null)">
        <div style="font-size:2rem;">+</div>
        <div>Create New Deck</div>
    </div>`;

    grid.innerHTML = html;
}

function openEditor(id) {
    editingDeck = id;
    const overlay = document.getElementById('editorOverlay');
    overlay.classList.add('show');

    if (id && decks[id]) {
        document.getElementById('editorTitle').textContent = 'Edit Deck';
        document.getElementById('deckName').value = decks[id].name;
        document.getElementById('deckDesc').value = decks[id].description || '';
        document.getElementById('deleteBtn').style.display = 'block';
        renderWordList(decks[id].words);
    } else {
        document.getElementById('editorTitle').textContent = 'Create New Deck';
        document.getElementById('deckName').value = '';
        document.getElementById('deckDesc').value = '';
        document.getElementById('deleteBtn').style.display = 'none';
        renderWordList([{ word: '', translation: '', definition: '' }]);
    }
}

function closeEditor() {
    document.getElementById('editorOverlay').classList.remove('show');
}

function renderWordList(words) {
    const container = document.getElementById('wordList');
    container.innerHTML = words.map((w, i) => `
        <div class="word-item" data-index="${i}">
            <input type="text" placeholder="Word" value="${w.word || ''}" data-field="word">
            <input type="text" placeholder="Translation" value="${w.translation || ''}" data-field="translation">
            <input type="text" placeholder="Definition" value="${w.definition || ''}" data-field="definition">
            <button class="delete-word" onclick="removeWordRow(${i})">√ó</button>
        </div>
    `).join('');
}

function addWordRow() {
    const container = document.getElementById('wordList');
    const idx = container.children.length;
    const div = document.createElement('div');
    div.className = 'word-item';
    div.dataset.index = idx;
    div.innerHTML = `
        <input type="text" placeholder="Word" data-field="word">
        <input type="text" placeholder="Translation" data-field="translation">
        <input type="text" placeholder="Definition" data-field="definition">
        <button class="delete-word" onclick="removeWordRow(${idx})">√ó</button>
    `;
    container.appendChild(div);
}

function removeWordRow(idx) {
    const items = document.querySelectorAll('#wordList .word-item');
    if (items[idx]) items[idx].remove();
}

function getEditorWords() {
    const words = [];
    document.querySelectorAll('#wordList .word-item').forEach(item => {
        const word = item.querySelector('[data-field="word"]').value.trim();
        const translation = item.querySelector('[data-field="translation"]').value.trim();
        const definition = item.querySelector('[data-field="definition"]').value.trim();
        if (word) words.push({ word, translation, definition });
    });
    return words;
}

async function saveDeck() {
    const name = document.getElementById('deckName').value.trim();
    const description = document.getElementById('deckDesc').value.trim();
    const words = getEditorWords();

    if (!name) return alert('Please enter a deck name');
    if (words.length === 0) return alert('Please add at least one word');

    const id = editingDeck || 'deck_' + Date.now();
    decks[id] = { name, description, words };

    try {
        await fetch('/api/save-deck', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, ...decks[id] })
        });
    } catch {}

    closeEditor();
    populateDeckSelects();
    renderDeckGrid();
    if (!currentDeck) loadDeck(id);
}

async function deleteDeck() {
    if (!editingDeck) return;
    if (!confirm('Delete this deck?')) return;

    delete decks[editingDeck];
    try {
        await fetch('/api/delete-deck', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: editingDeck })
        });
    } catch {}

    closeEditor();
    populateDeckSelects();
    renderDeckGrid();
    if (currentDeck === editingDeck) {
        currentDeck = Object.keys(decks)[0] || null;
        if (currentDeck) loadDeck(currentDeck);
    }
}

function exportDeck() {
    const name = document.getElementById('deckName').value.trim() || 'deck';
    const words = getEditorWords();
    const data = { name, words };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name.replace(/\s+/g, '_') + '.json';
    a.click();
}

// ===== Import =====
const importArea = document.getElementById('importArea');
importArea.addEventListener('dragover', e => { e.preventDefault(); importArea.classList.add('dragover'); });
importArea.addEventListener('dragleave', () => importArea.classList.remove('dragover'));
importArea.addEventListener('drop', e => {
    e.preventDefault();
    importArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) importFile(file);
});

function handleFileImport(e) {
    const file = e.target.files[0];
    if (file) importFile(file);
}

async function importFile(file) {
    const text = await file.text();
    let data;

    if (file.name.endsWith('.json')) {
        try { data = JSON.parse(text); } catch { return alert('Invalid JSON'); }
    } else {
        // TSV
        const lines = text.trim().split('\n');
        const words = lines.map(line => {
            const [word, translation, definition] = line.split('\t');
            return { word: word?.trim(), translation: translation?.trim(), definition: definition?.trim() };
        }).filter(w => w.word);
        data = { name: file.name.replace(/\.\w+$/, ''), words };
    }

    if (!data.words || !data.words.length) return alert('No words found');

    const id = 'deck_' + Date.now();
    decks[id] = { name: data.name || 'Imported', description: '', words: data.words };

    await fetch('/api/save-deck', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, ...decks[id] })
    });

    populateDeckSelects();
    renderDeckGrid();
    loadDeck(id);
    alert(`Imported "${data.name}" with ${data.words.length} words`);
}

// ===== Keyboard =====
document.addEventListener('keydown', e => {
    if (document.getElementById('editorOverlay').classList.contains('show')) return;
    if (document.activeElement.tagName === 'INPUT') return;

    if (currentView === 'flashcard') {
        if (e.code === 'Space') { e.preventDefault(); flipCard(); }
        if (isFlipped && e.key >= '1' && e.key <= '4') rateCard(parseInt(e.key) - 1);
    }
});

// ===== Stats =====
async function showStats() {
    const overlay = document.getElementById('statsOverlay');
    overlay.classList.add('show');

    try {
        const res = await fetch('/api/sessions');
        const history = await res.json();
        
        // Overall Stats
        let totalTotal = 0;
        let totalCorrect = 0;
        let totalS = 0;
        
        history.forEach(s => {
            totalTotal += s.total;
            totalCorrect += s.correct;
            totalS += s.score;
        });

        document.getElementById('totalReviewed').textContent = totalTotal;
        document.getElementById('avgAccuracy').textContent = totalTotal ? Math.round((totalCorrect / totalTotal) * 100) + '%' : '0%';
        document.getElementById('totalScore').textContent = totalS;

        // Session History Table
        const tbody = document.getElementById('sessionHistory');
        tbody.innerHTML = history.reverse().slice(0, 10).map(s => {
            const date = new Date(s.timestamp).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const deckName = decks[s.deck] ? decks[s.deck].name : 'Unknown Deck';
            const acc = s.total ? Math.round((s.correct / s.total) * 100) : 0;
            return `
                <tr>
                    <td style="color: var(--sub);">${date}</td>
                    <td style="font-weight: 600;">${deckName}</td>
                    <td><span class="mode-badge">${s.mode}</span></td>
                    <td style="color: var(--acc); font-weight: 700;">${acc}%</td>
                    <td style="font-weight: 600;">${s.score}</td>
                </tr>
            `;
        }).join('');

    } catch (e) {
        console.error('Failed to load stats', e);
    }
}

// ===== Init =====
loadDecks();
</script>
</body>
</html>
