<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vocalo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #09090b; --main: #fafafa; --sub: #a1a1aa;
            --acc: #4ade80; --err: #f43f5e; --card-bg: #18181b;
            --success: #22c55e; --warning: #fbbf24;
            --border: rgba(255, 255, 255, 0.12);
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            --shadow-sm: 0 2px 8px -2px rgba(0, 0, 0, 0.3);
            --input-height: 52px;
        }
        [data-theme="light"] { 
            --bg: #ffffff; --main: #09090b; --sub: #52525b; 
            --acc: #16a34a; --err: #dc2626; --card-bg: #f4f4f5; 
            --border: rgba(0, 0, 0, 0.1);
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.15);
            --shadow-sm: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        [data-theme="nord"] { --bg: #2e3440; --main: #eceff4; --sub: #88c0d0; --acc: #8fbcbb; --err: #bf616a; --card-bg: #3b4252; --border: rgba(255,255,255,0.1); }
        [data-theme="dracula"] { --bg: #282a36; --main: #f8f8f2; --sub: #bd93f9; --acc: #50fa7b; --err: #ff5555; --card-bg: #44475a; --border: rgba(255,255,255,0.1); }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background: var(--bg); color: var(--main); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            min-height: 100vh; 
            transition: background 0.3s, color 0.3s;
            line-height: 1.5;
            overflow-y: scroll; /* Prevent layout shift */
        }

        button, select, input { font-family: inherit; }

        /* --- Header --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.25rem 2rem; border-bottom: 1px solid var(--border);
            max-width: 1200px; margin: 0 auto;
            position: sticky; top: 0; z-index: 50;
            background: var(--bg);
            backdrop-filter: blur(8px);
        }
        .logo { font-weight: 800; font-size: 1.5rem; letter-spacing: -0.05em; user-select: none; }
        .logo span { color: var(--acc); }

        .nav { 
            display: flex; gap: 0.25rem; background: var(--card-bg); 
            padding: 0.25rem; border-radius: 12px; border: 1px solid var(--border); 
        }
        .nav-btn {
            background: transparent; border: none;
            color: var(--sub); padding: 0.5rem 1rem; border-radius: 8px;
            cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s;
        }
        .nav-btn:hover { color: var(--main); }
        .nav-btn.active { background: var(--bg); color: var(--main); box-shadow: var(--shadow-sm); }

        .controls { display: flex; gap: 0.75rem; align-items: center; }
        .select-wrap select {
            background: var(--card-bg); border: 1px solid var(--border);
            color: var(--main); padding: 0.5rem 1rem; border-radius: 8px;
            cursor: pointer; font-size: 0.875rem; transition: 0.2s; outline: none;
        }
        .select-wrap select:hover, .select-wrap select:focus { border-color: var(--sub); }

        .icon-btn {
            background: var(--card-bg); border: 1px solid var(--border); color: var(--sub);
            cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; height: 36px; width: 36px;
        }
        .icon-btn:hover { color: var(--acc); border-color: var(--acc); }

        /* --- Main Layout --- */
        .main { max-width: 900px; margin: 0 auto; padding: 2.5rem 1.5rem; }

        /* --- Deck Header (Uniform Heights) --- */
        .deck-header {
            display: grid;
            grid-template-areas: 
                "select progress"
                "stats stats";
            grid-template-columns: minmax(200px, 300px) 1fr;
            align-items: stretch;
            gap: 1rem 1.5rem;
            margin-bottom: 2.5rem;
        }

        /* 1. Deck Selector */
        .deck-select {
            grid-area: select;
            background: var(--card-bg); 
            border: 1px solid var(--border);
            color: var(--main); 
            padding: 0 1.25rem; 
            border-radius: 14px;
            font-size: 0.95rem; font-weight: 600; 
            cursor: pointer;
            transition: all 0.2s;
            height: var(--input-height);
            width: 100%;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2371717a'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2rem;
            padding-right: 3rem;
            box-shadow: var(--shadow-sm);
        }
        .deck-select:hover, .deck-select:focus { border-color: var(--acc); }

        /* 2. Progress Bar (Pill Style) */
        .progress-bar-container { 
            grid-area: progress; 
            display: flex; flex-direction: column; justify-content: center;
        }
        .progress-bar {
            background: var(--card-bg);
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--border);
            position: relative;
            height: var(--input-height); /* Explicit height match */
            box-shadow: var(--shadow-sm);
        }
        .progress-label { 
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.25rem;
            
            /* FIX: removed mix-blend-mode, forced explicit high contrast colors */
            color: var(--main); 
            mix-blend-mode: normal; 
            filter: none;
            
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            z-index: 2;
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3); /* improved legibility */
        }
        /* Specific fix for light themes since difference/invert can be tricky */
        [data-theme="light"] .progress-label { mix-blend-mode: normal; filter: none; color: var(--main); }
        [data-theme="light"] .progress-label span { text-shadow: 0 0 10px rgba(255,255,255,0.8); }

        .progress-fill {
            height: 100%; 
            background: var(--acc);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1);
            opacity: 0.2; /* Subtle fill style */
        }
        [data-theme="light"] .progress-fill { opacity: 0.3; }

        /* 3. Stats */
        .deck-stats {
            grid-area: stats;
            display: flex; gap: 1.5rem; 
            color: var(--sub); font-size: 0.825rem; font-weight: 600;
            padding-left: 0.5rem;
        }
        .deck-stats span { display: flex; align-items: center; gap: 0.6rem; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot.new { background: var(--sub); opacity: 0.5; }
        .dot.learning { background: var(--warning); box-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }
        .dot.mastered { background: var(--success); box-shadow: 0 0 8px rgba(34, 197, 94, 0.4); }

        /* --- Flashcard --- */
        .card-container { perspective: 1200px; margin: 1rem 0 2rem 0; }
        .flashcard {
            width: 100%; min-height: 400px; position: relative;
            transform-style: preserve-3d; 
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        .flashcard.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 24px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 3rem; background: var(--card-bg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .flashcard.changing .card-face { opacity: 0; transition: opacity 0.2s; }
        .card-back { transform: rotateY(180deg); background: var(--card-bg); }

        .card-label {
            position: absolute; top: 2rem; left: 2rem;
            font-size: 0.75rem; text-transform: uppercase;
            letter-spacing: 0.12em; color: var(--sub); font-weight: 700; opacity: 0.7;
        }
        .card-word {
            font-size: 3.5rem; font-weight: 800; text-align: center;
            letter-spacing: -0.03em; line-height: 1.1; margin-bottom: 0.5rem;
        }
        .card-hint { margin-top: 1rem; color: var(--sub); font-size: 1rem; font-style: italic; }
        .card-example {
            margin-top: 2rem; color: var(--sub); font-size: 1.1rem;
            max-width: 500px; text-align: center; line-height: 1.6;
        }

        /* --- Actions --- */
        .card-actions {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; 
            margin-top: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;
        }
        .action-btn {
            padding: 1rem 0.5rem; border-radius: 14px;
            font-size: 0.95rem; font-weight: 600; cursor: pointer;
            background: var(--card-bg); border: 1px solid var(--border);
            color: var(--main); transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .action-btn span { font-size: 0.7rem; opacity: 0.6; font-weight: 400; }
        
        .action-btn.again:hover { border-color: var(--err); color: var(--err); background: rgba(244, 63, 94, 0.05); transform: translateY(-2px); }
        .action-btn.hard:hover  { border-color: var(--warning); color: var(--warning); background: rgba(245, 158, 11, 0.05); transform: translateY(-2px); }
        .action-btn.good:hover  { border-color: var(--acc); color: var(--acc); background: rgba(74, 222, 128, 0.05); transform: translateY(-2px); }
        .action-btn.easy:hover  { border-color: var(--success); color: var(--success); background: rgba(34, 197, 94, 0.05); transform: translateY(-2px); }
        
        .flip-hint {
            text-align: center; color: var(--sub); font-size: 0.85rem;
            margin-top: 2.5rem; font-weight: 500; opacity: 0.8;
        }
        .key { 
            background: rgba(128,128,128,0.15); border: 1px solid var(--border); 
            padding: 2px 6px; border-radius: 6px; font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem; color: var(--main); margin: 0 2px;
        }

        /* --- Type Mode --- */
        .type-container { text-align: center; max-width: 700px; margin: 0 auto; }
        .prompt-card {
            background: var(--card-bg); border-radius: 24px;
            padding: 5rem 2rem; margin-bottom: 2.5rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: relative; overflow: hidden;
        }
        /* Subtle glow effect for prompt */
        .prompt-card::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, transparent, var(--acc), transparent);
            opacity: 0.5;
        }
        .prompt-label {
            font-size: 0.75rem; text-transform: uppercase;
            letter-spacing: 0.12em; color: var(--sub); margin-bottom: 1.5rem; font-weight: 700;
        }
        .prompt-text {
            font-size: 2.5rem; font-weight: 800; line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .type-input-wrap { position: relative; max-width: 500px; margin: 0 auto; }
        .type-input {
            width: 100%; padding: 1.25rem 1.5rem; font-size: 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg); border: 2px solid var(--border);
            border-radius: 16px; color: var(--main);
            text-align: center; outline: none; transition: 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .type-input:focus { border-color: var(--acc); transform: translateY(-2px); box-shadow: var(--shadow); }
        .type-input.correct { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }
        .type-input.incorrect { border-color: var(--err); background: rgba(244, 63, 94, 0.05); }

        .type-feedback { margin-top: 1.5rem; font-size: 1.1rem; min-height: 1.5rem; font-weight: 700; }
        .type-feedback.correct { color: var(--success); }
        .type-feedback.incorrect { color: var(--err); }

        .correct-answer {
            margin-top: 1rem; padding: 1rem 1.5rem;
            background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace; font-size: 1rem;
            color: var(--acc); display: inline-block;
        }

        .score-display {
            display: flex; justify-content: center; gap: 4rem;
            margin-bottom: 3rem;
        }
        .score-item { text-align: center; }
        .score-val { font-size: 2rem; font-weight: 800; color: var(--main); line-height: 1; letter-spacing: -0.03em; }
        .score-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--sub); margin-top: 0.5rem; font-weight: 700; }

        /* --- Completion Screen --- */
        .complete-screen { text-align: center; padding: 4rem 0; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .complete-icon { font-size: 5rem; margin-bottom: 1.5rem; display: inline-block; animation: bounce 1s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }

        .complete-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; letter-spacing: -0.03em; }
        .complete-subtitle { color: var(--sub); margin-bottom: 3rem; font-weight: 500; font-size: 1.1rem; }
        .complete-stats {
            display: flex; justify-content: center; gap: 3rem; margin-bottom: 3rem;
            background: var(--card-bg); padding: 2.5rem; border-radius: 24px; border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .error-list { margin: 3rem auto; text-align: left; max-width: 600px; }
        .error-list h4 { margin-bottom: 1.5rem; font-size: 1rem; color: var(--err); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        .error-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.25rem; background: var(--card-bg); border-radius: 12px;
            margin-bottom: 0.75rem; border: 1px solid var(--border);
        }
        .error-word { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--main); font-size: 1.1rem; }
        .error-trans { color: var(--sub); font-size: 0.95rem; }

        /* --- Deck Manager --- */
        .manager { padding: 3rem 1.5rem; max-width: 1000px; margin: 0 auto; }
        .manager h2 { font-size: 2rem; font-weight: 800; margin-bottom: 2rem; letter-spacing: -0.03em; }

        .deck-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem; margin-bottom: 4rem;
        }
        .deck-card {
            background: var(--card-bg); border-radius: 20px; padding: 2rem;
            border: 1px solid var(--border); cursor: pointer;
            transition: all 0.2s; box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; height: 100%;
        }
        .deck-card:hover { border-color: var(--acc); transform: translateY(-4px); box-shadow: var(--shadow); }
        .deck-card h3 { font-size: 1.4rem; margin-bottom: 0.5rem; font-weight: 700; letter-spacing: -0.02em; }
        .deck-card .meta { color: var(--sub); font-size: 0.9rem; font-weight: 500; margin-top: auto; padding-top: 1rem; }

        .add-deck-card {
            border: 2px dashed var(--border); display: flex;
            align-items: center; justify-content: center; text-align: center;
            color: var(--sub); min-height: 180px; background: transparent; gap: 1rem;
        }
        .add-deck-card:hover { border-color: var(--acc); color: var(--acc); background: rgba(74, 222, 128, 0.05); }

        .import-area {
            border: 2px dashed var(--border); border-radius: 20px;
            padding: 4rem 2rem; text-align: center; margin: 2rem 0;
            transition: all 0.2s; cursor: pointer;
            background: var(--card-bg);
        }
        .import-area:hover { border-color: var(--acc); background: rgba(74, 222, 128, 0.05); }
        .import-area p:first-child { color: var(--main); font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }

        .format-hint {
            background: var(--card-bg); padding: 2rem;
            border-radius: 20px; font-size: 0.85rem; color: var(--sub);
            margin-top: 2rem; font-family: 'JetBrains Mono', monospace;
            white-space: pre-line; text-align: left;
            border: 1px solid var(--border); line-height: 1.7;
        }
        .format-hint strong { color: var(--acc); }

        /* --- Modals --- */
        .overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: all 0.3s ease;
        }
        .overlay.show { opacity: 1; pointer-events: all; }

        .modal {
            background: var(--bg); border-radius: 24px;
            width: 95%; max-width: 900px; max-height: 90vh;
            border: 1px solid var(--border);
            box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.7);
            transform: translateY(20px) scale(0.98);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .overlay.show .modal { transform: translateY(0) scale(1); }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.5rem 2rem; background: var(--bg);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 10;
        }
        .modal-header h2 { font-size: 1.4rem; font-weight: 800; letter-spacing: -0.02em; }
        .modal-content { padding: 2rem; overflow-y: auto; flex: 1; }
        .modal-footer {
            padding: 1.5rem 2rem; background: var(--card-bg);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.75rem; color: var(--sub); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.6rem; font-weight: 700; }
        .form-input {
            width: 100%; padding: 0.9rem 1.1rem; font-size: 1rem;
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 12px; color: var(--main); transition: all 0.2s;
        }
        .form-input:focus { outline: none; border-color: var(--acc); background: var(--bg); }

        .word-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .word-item {
            display: grid; grid-template-columns: 1fr 1fr 1fr 40px;
            gap: 1rem; padding: 1rem; background: var(--card-bg);
            border-radius: 14px; align-items: center;
            border: 1px solid var(--border); transition: 0.2s;
        }
        .word-item input {
            padding: 0.6rem 0.9rem; background: var(--bg);
            border: 1px solid var(--border); border-radius: 10px;
            color: var(--main); font-size: 0.9rem; width: 100%;
        }
        .word-item input:focus { border-color: var(--acc); outline: none; }
        
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 12px; font-size: 0.9rem;
            font-weight: 600; cursor: pointer; border: none; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary { background: var(--acc); color: #000; box-shadow: 0 4px 12px rgba(74, 222, 128, 0.2); }
        .btn-secondary { background: var(--bg); border: 1px solid var(--border); color: var(--main); }
        .btn-danger { background: rgba(244, 63, 94, 0.1); color: var(--err); }
        .btn-danger:hover { background: var(--err); color: #fff; }
        .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }

        /* Stats Modal Specifics */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 3rem; }
        .stat-card { background: var(--card-bg); padding: 1.5rem; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        .stat-card .val { font-size: 2.25rem; font-weight: 800; color: var(--acc); display: block; letter-spacing: -0.03em; }
        .stat-card .label { font-size: 0.7rem; text-transform: uppercase; color: var(--sub); font-weight: 700; margin-top: 0.5rem; display: block; }

        .history-table { width: 100%; border-collapse: separate; border-spacing: 0 0.5rem; }
        .history-table th { text-align: left; padding: 0.5rem 1rem; color: var(--sub); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .history-table td { padding: 1rem; background: var(--card-bg); font-size: 0.9rem; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .history-table tr td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; border-left: 1px solid var(--border); }
        .history-table tr td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; border-right: 1px solid var(--border); }
        .mode-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; background: var(--bg); border: 1px solid var(--border); letter-spacing: 0.05em; }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--sub); }

        /* --- Mobile Polish --- */
        /* --- Mobile Polish --- */
        @media (max-width: 768px) {
            .header {
                display: flex; 
                flex-direction: column; 
                align-items: flex-start; /* Changed from stretch to handle positioning better */
                padding: 1rem; 
                gap: 1rem;
                position: sticky; /* Ensure relative context for absolute controls */
            }
            
            /* Removed the generic .header > div selector */
            
            .header .logo { 
                text-align: left; 
                width: 100%;
            }
            
            .header .controls { 
                position: absolute; 
                top: 1rem; 
                right: 1rem; 
                width: auto; 
            }
            
            .nav { 
                width: 100%; /* Ensure nav takes full width on mobile */
                overflow-x: auto; 
                white-space: nowrap; 
                padding: 0.4rem; 
                -webkit-overflow-scrolling: touch; 
                justify-content: flex-start; 
            }
            .nav::-webkit-scrollbar { display: none; }
            .nav-btn { flex: 0 0 auto; }
        
            .main { padding: 1.5rem 1rem; }
            
            /* Stack Grid for Mobile */
            .deck-header {
                grid-template-areas: 
                    "select"
                    "progress"
                    "stats";
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .deck-select, .progress-bar { height: 52px; }
        
            .card-word { font-size: 2.5rem; }
            .card-face { padding: 1.5rem; }
            .card-actions { grid-template-columns: 1fr 1fr; gap: 0.75rem; }
            
            .complete-stats { flex-direction: column; gap: 1.5rem; padding: 1.5rem; }
            .score-display { gap: 1.5rem; }
            
            .stats-grid, .form-grid { grid-template-columns: 1fr; }
            
            .word-item { grid-template-columns: 1fr; gap: 0.75rem; position: relative; padding-top: 2rem; }
            .word-item .delete-word { position: absolute; top: 0.5rem; right: 0.5rem; }
            
            .history-table th:nth-child(3), .history-table td:nth-child(3) { display: none; }
            
            .prompt-text { font-size: 1.75rem; }
            .type-input { font-size: 1.25rem; padding: 1rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">voca<span>lo</span></div>
        
        <!-- Nav moved to the middle -->
        <div class="nav">
            <button class="nav-btn active" data-view="flashcard">Flashcards</button>
            <button class="nav-btn" data-view="type">Type Mode</button>
            <button class="nav-btn" data-view="decks">Manage Decks</button>
        </div>
    
        <!-- Controls moved to the end (Right side) -->
        <div class="controls">
            <div class="select-wrap">
                <select id="themeSelect" onchange="setTheme(this.value)">
                    <option value="default">Dark</option>
                    <option value="light">Light</option>
                    <option value="nord">Nord</option>
                    <option value="dracula">Dracula</option>
                </select>
            </div>
            <button class="icon-btn" onclick="showStats()" title="Statistics">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Flashcard View -->
    <div class="main view-flashcard">
        <div class="deck-header">
            <select class="deck-select" id="deckSelect" onchange="loadDeck(this.value)"></select>

            <div class="progress-bar-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-label">
                        <span>Progress</span>
                        <span id="progressText">0%</span>
                    </div>
                </div>
            </div>

            <div class="deck-stats">
                <span title="New Words"><div class="dot new"></div> <span id="newCount">0</span> New</span>
                <span title="Learning"><div class="dot learning"></div> <span id="learningCount">0</span> Learning</span>
                <span title="Mastered"><div class="dot mastered"></div> <span id="masteredCount">0</span> Mastered</span>
            </div>
        </div>

        <div id="flashcardArea">
            <div class="card-container">
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="card-face card-front">
                        <div class="card-label" id="frontLabel">Word</div>
                        <div class="card-word" id="frontText"></div>
                        <div class="card-hint" id="frontHint"></div>
                    </div>
                    <div class="card-face card-back">
                        <div class="card-label" id="backLabel">Translation</div>
                        <div class="card-word" id="backText"></div>
                        <div class="card-example" id="exampleText"></div>
                    </div>
                </div>
            </div>

            <div class="flip-hint">Press <span class="key">Space</span> to flip ¬∑ <span class="key">1-4</span> to rate</div>

            <div class="card-actions" id="cardActions" style="display:none; opacity: 0; animation: fadeIn 0.3s forwards;">
                <button class="action-btn again" onclick="rateCard(0)">Again <span>&lt; 1min</span></button>
                <button class="action-btn hard" onclick="rateCard(1)">Hard <span>2d</span></button>
                <button class="action-btn good" onclick="rateCard(2)">Good <span>4d</span></button>
                <button class="action-btn easy" onclick="rateCard(3)">Easy <span>7d</span></button>
            </div>
        </div>

        <div id="completeArea" class="complete-screen" style="display:none;">
            <div class="complete-icon">üéâ</div>
            <div class="complete-title">Session Complete</div>
            <div class="complete-subtitle">You've reviewed all cards in this deck</div>
            <div class="complete-stats">
                <div class="score-item"><div class="score-val" id="sessionCorrect">0</div><div class="score-label">Correct</div></div>
                <div class="score-item"><div class="score-val" id="sessionTotal">0</div><div class="score-label">Total</div></div>
                <div class="score-item"><div class="score-val" id="sessionAccuracy">0%</div><div class="score-label">Accuracy</div></div>
            </div>
            <div id="errorList" class="error-list" style="display:none;">
                <h4>Review Errors</h4>
                <div id="errorItems"></div>
            </div>
            <button class="btn btn-primary" onclick="restartSession()">Study Again</button>
        </div>
    </div>

    <!-- Type Mode View -->
    <div class="main view-type" style="display:none;">
        <div class="deck-header">
            <select class="deck-select" id="typeDeckSelect" onchange="loadDeck(this.value)"></select>

            <div class="progress-bar-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="typeProgress"></div>
                    <div class="progress-label">
                        <span>Session</span>
                        <span id="typeProgressText">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="typeArea">
            <div class="score-display">
                <div class="score-item"><div class="score-val" id="typeScore">0</div><div class="score-label">Score</div></div>
                <div class="score-item"><div class="score-val" id="typeStreak">0</div><div class="score-label">Streak</div></div>
            </div>

            <div class="type-container">
                <div class="prompt-card">
                    <div class="prompt-label" id="typePromptLabel">Translation</div>
                    <div class="prompt-text" id="typePrompt"></div>
                </div>

                <div class="type-input-wrap">
                    <input type="text" class="type-input" id="typeInput" placeholder="Type answer..." autocomplete="off">
                </div>

                <div class="type-feedback" id="typeFeedback"></div>
                <div class="correct-answer" id="correctAnswer" style="display:none;"></div>

                <div style="margin-top:2rem; min-height: 48px;">
                    <button class="btn btn-primary" id="nextBtn" onclick="nextTypeCard()" style="display:none;">Next Word <span class="key" style="background:rgba(0,0,0,0.2); border:none;">‚Üµ</span></button>
                </div>

                <div class="flip-hint" style="margin-top:3rem;">Press <span class="key">Enter</span> to check</div>
            </div>
        </div>

        <div id="typeCompleteArea" class="complete-screen" style="display:none;">
            <div class="complete-icon">üèÜ</div>
            <div class="complete-title">Training Done!</div>
            <div class="complete-subtitle">Great progress in this session</div>
            <div class="complete-stats">
                <div class="score-item"><div class="score-val" id="typeSessionScore">0</div><div class="score-label">Final Score</div></div>
                <div class="score-item"><div class="score-val" id="typeSessionCorrect">0</div><div class="score-label">Correct</div></div>
                <div class="score-item"><div class="score-val" id="typeSessionAccuracy">0%</div><div class="score-label">Accuracy</div></div>
            </div>
            <div id="typeErrorList" class="error-list" style="display:none;">
                <h4>Missed Words</h4>
                <div id="typeErrorItems"></div>
            </div>
            <button class="btn btn-primary" onclick="restartSession()">Try Again</button>
        </div>
    </div>

    <!-- Deck Manager View -->
    <div class="manager view-decks" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>Your Decks</h2>
            <button class="btn btn-primary" onclick="openEditor(null)">+ New Deck</button>
        </div>

        <div class="deck-grid" id="deckGrid"></div>

        <h2 style="margin-top:3rem; font-size:1.5rem;">Import / Export</h2>
        <div class="import-area" id="importArea" onclick="document.getElementById('fileInput').click()">
            <p>Drop a file here or click to import</p>
            <p style="font-size:0.9rem;color:var(--sub);margin-top:0.5rem;">Supports .json and .tsv files</p>
        </div>
        <input type="file" id="fileInput" style="display:none" accept=".json,.tsv,.txt" onchange="handleFileImport(event)">

        <div class="format-hint">
<strong>JSON format:</strong>
{"name": "Deck Name", "words": [{"word": "hola", "translation": "hello", "definition": "greeting"}]}

<strong>TSV format (tab-separated):</strong>
word    translation    definition
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="overlay" id="statsOverlay" onclick="if(event.target===this)this.classList.remove('show')">
        <div class="modal">
            <div class="modal-header">
                <h2>Learning Progress</h2>
                <button class="icon-btn" onclick="document.getElementById('statsOverlay').classList.remove('show')">‚úï</button>
            </div>
            <div class="modal-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="val" id="totalReviewed">0</span>
                        <span class="label">Cards Reviewed</span>
                    </div>
                    <div class="stat-card">
                        <span class="val" id="avgAccuracy">0%</span>
                        <span class="label">Avg. Accuracy</span>
                    </div>
                    <div class="stat-card">
                        <span class="val" id="totalScore">0</span>
                        <span class="label">Total Score</span>
                    </div>
                </div>

                <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em;">Recent Sessions</h3>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Deck</th>
                                <th>Mode</th>
                                <th>Accuracy</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody id="sessionHistory"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Editor Modal -->
    <div class="overlay" id="editorOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="editorTitle">Edit Deck</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="exportDeck()">Export</button>
                    <button class="icon-btn" onclick="closeEditor()">‚úï</button>
                </div>
            </div>

            <div class="modal-content">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Deck Name</label>
                        <input type="text" class="form-input" id="deckName" placeholder="e.g., Spanish Basics">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" id="deckDesc" placeholder="e.g., Common Spanish words">
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
                    <h3 style="font-size: 1rem; font-weight: 700; color: var(--sub);">Word List</h3>
                    <button class="btn btn-secondary" onclick="addWordRow()" style="padding: 0.5rem 1rem; font-size: 0.8rem;">+ Add Word</button>
                </div>

                <div class="word-list" id="wordList"></div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteBtn" onclick="deleteDeck()">Delete Deck</button>
                <div style="display:flex; gap:1rem; align-items:center;">
                    <span style="color: var(--sub); font-size: 0.8rem; font-weight: 500;" class="mobile-hide">
                        Use <span class="key">Tab</span> to navigate
                    </span>
                    <button class="btn btn-primary" onclick="saveDeck()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

<script>
// ===== State =====
let decks = {};
let currentDeck = null;
let currentCards = [];
let cardIndex = 0;
let isFlipped = false;
let currentView = 'flashcard';
let session = { correct: 0, total: 0, streak: 0, score: 0, missed: [] };
let progress = JSON.parse(localStorage.getItem('vocabProgress') || '{}');

// ===== Theme =====
function setTheme(t) {
    document.documentElement.setAttribute('data-theme', t || 'default');
    localStorage.setItem('theme', t || 'default');
    document.getElementById('themeSelect').value = t || 'default';
}
setTheme(localStorage.getItem('theme'));

// ===== View Navigation =====
document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        if (btn.classList.contains('active')) return;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentView = btn.dataset.view;
        document.querySelectorAll('.main, .manager').forEach(v => v.style.display = 'none');
        document.querySelector('.view-' + currentView).style.display = 'block';
        if (currentView === 'decks') renderDeckGrid();
        else startSession();
    });
});

// ===== Load Decks =====
async function loadDecks() {
    // Simulated default deck if empty
    if(Object.keys(decks).length === 0 && !localStorage.getItem('decks_loaded')) {
        decks['demo'] = {
            name: 'Demo Spanish',
            description: 'Basic vocabulary',
            words: [
                {word: 'Hola', translation: 'Hello', definition: 'A greeting', example: 'Hola, ¬øc√≥mo est√°s?'},
                {word: 'Gato', translation: 'Cat', definition: 'A small feline', example: 'El gato duerme.'},
                {word: 'Amigo', translation: 'Friend', definition: 'A person you like', example: 'Es mi mejor amigo.'}
            ]
        };
        localStorage.setItem('decks_loaded', 'true');
    }

    populateDeckSelects();
    if (Object.keys(decks).length > 0) {
        loadDeck(Object.keys(decks)[0]);
    }
}

function populateDeckSelects() {
    const opts = Object.keys(decks).map(k => `<option value="${k}">${decks[k].name}</option>`).join('');
    document.getElementById('deckSelect').innerHTML = opts || '<option>No decks</option>';
    document.getElementById('typeDeckSelect').innerHTML = opts || '<option>No decks</option>';
}

function loadDeck(id) {
    if (!decks[id]) return;
    currentDeck = id;
    document.getElementById('deckSelect').value = id;
    document.getElementById('typeDeckSelect').value = id;
    startSession();
}

function startSession() {
    if (!currentDeck || !decks[currentDeck]) return;

    session = { correct: 0, total: 0, streak: 0, score: 0, missed: [] };
    currentCards = [...decks[currentDeck].words];
    shuffleArray(currentCards);
    cardIndex = 0;

    document.getElementById('flashcardArea').style.display = 'block';
    document.getElementById('completeArea').style.display = 'none';
    document.getElementById('typeArea').style.display = 'block';
    document.getElementById('typeCompleteArea').style.display = 'none';

    updateDeckStats();
    if (currentView === 'flashcard') showCard();
    if (currentView === 'type') showTypeCard();
}

function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
}

// ===== Flashcard Mode =====
function showCard() {
    if (cardIndex >= currentCards.length) {
        showComplete();
        return;
    }

    const card = currentCards[cardIndex];
    document.getElementById('frontText').textContent = card.word;
    document.getElementById('frontHint').textContent = card.hint || '';
    document.getElementById('backText').textContent = card.translation || card.definition || '';
    document.getElementById('exampleText').textContent = card.example || '';
    
    // Reset state
    const el = document.getElementById('flashcard');
    isFlipped = false;
    el.classList.remove('flipped');
    document.getElementById('cardActions').style.display = 'none';
    
    updateProgress();
}

function flipCard() {
    isFlipped = !isFlipped;
    document.getElementById('flashcard').classList.toggle('flipped', isFlipped);
    
    const actions = document.getElementById('cardActions');
    if (isFlipped) {
        actions.style.display = 'grid';
        actions.style.animation = 'none';
        actions.offsetHeight; /* trigger reflow */
        actions.style.animation = 'fadeIn 0.3s forwards';
    } else {
        actions.style.display = 'none';
    }
}

function rateCard(rating) {
    if (!isFlipped) return flipCard();

    const card = currentCards[cardIndex];
    const key = currentDeck + ':' + card.word;

    if (!progress[key]) progress[key] = { level: 0, lastSeen: 0 };
    progress[key].lastSeen = Date.now();

    if (rating >= 2) {
        progress[key].level = Math.min(3, progress[key].level + 1);
        session.correct++;
    } else {
        progress[key].level = Math.max(0, progress[key].level - 1);
        session.missed.push(card);
    }
    session.total++;
    localStorage.setItem('vocabProgress', JSON.stringify(progress));

    const el = document.getElementById('flashcard');
    el.classList.add('changing');
    
    setTimeout(() => {
        cardIndex++;
        showCard();
        updateDeckStats();
        el.classList.remove('changing');
    }, 250); 
}

function updateProgress() {
    const pct = currentCards.length ? Math.round((cardIndex / currentCards.length) * 100) : 0;
    const bar = currentView === 'flashcard' ? 'progressFill' : 'typeProgress';
    const text = currentView === 'flashcard' ? 'progressText' : 'typeProgressText';
    document.getElementById(bar).style.width = pct + '%';
    document.getElementById(text).textContent = pct + '%';
}

function updateDeckStats() {
    if (!currentDeck || !decks[currentDeck]) return;

    let newC = 0, learning = 0, mastered = 0;
    decks[currentDeck].words.forEach(w => {
        const key = currentDeck + ':' + w.word;
        const p = progress[key];
        if (!p || p.level === 0) newC++;
        else if (p.level >= 3) mastered++;
        else learning++;
    });

    document.getElementById('newCount').textContent = newC;
    document.getElementById('learningCount').textContent = learning;
    document.getElementById('masteredCount').textContent = mastered;
}

function showComplete() {
    const sessionData = {
        timestamp: Date.now(),
        deck: currentDeck,
        mode: currentView,
        correct: session.correct,
        total: session.total,
        score: session.score
    };
    saveSessionLocal(sessionData);

    if (currentView === 'flashcard') {
        document.getElementById('flashcardArea').style.display = 'none';
        document.getElementById('completeArea').style.display = 'block';
        document.getElementById('sessionCorrect').textContent = session.correct;
        document.getElementById('sessionTotal').textContent = session.total;
        const acc = session.total ? Math.round((session.correct / session.total) * 100) : 0;
        document.getElementById('sessionAccuracy').textContent = acc + '%';
        renderErrors('errorList', 'errorItems');
    } else {
        document.getElementById('typeArea').style.display = 'none';
        document.getElementById('typeCompleteArea').style.display = 'block';
        document.getElementById('typeSessionScore').textContent = session.score;
        document.getElementById('typeSessionCorrect').textContent = session.correct;
        const acc = session.total ? Math.round((session.correct / session.total) * 100) : 0;
        document.getElementById('typeSessionAccuracy').textContent = acc + '%';
        renderErrors('typeErrorList', 'typeErrorItems');
    }
}

function renderErrors(listId, itemsId) {
    const list = document.getElementById(listId);
    const items = document.getElementById(itemsId);
    if (session.missed.length === 0) {
        list.style.display = 'none';
        return;
    }
    list.style.display = 'block';
    items.innerHTML = session.missed.map(m => `
        <div class="error-item">
            <div class="error-word">${m.word}</div>
            <div class="error-trans">${m.translation || m.definition}</div>
        </div>
    `).join('');
}

function restartSession() { startSession(); }

function saveSessionLocal(data) {
    let history = JSON.parse(localStorage.getItem('sessionHistory') || '[]');
    history.push(data);
    localStorage.setItem('sessionHistory', JSON.stringify(history));
}

// ===== Type Mode =====
let typeCard = null;
let typeAnswered = false;

function showTypeCard() {
    if (cardIndex >= currentCards.length) {
        showComplete();
        return;
    }

    typeCard = currentCards[cardIndex];
    typeAnswered = false;

    document.getElementById('typePromptLabel').textContent = typeCard.translation ? 'Translation' : 'Definition';
    document.getElementById('typePrompt').textContent = typeCard.translation || typeCard.definition || '???';

    const input = document.getElementById('typeInput');
    input.value = '';
    input.className = 'type-input';
    input.readOnly = false;
    input.focus();

    document.getElementById('typeFeedback').textContent = '';
    document.getElementById('typeFeedback').className = 'type-feedback';
    document.getElementById('correctAnswer').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'none';

    document.getElementById('typeScore').textContent = session.score;
    document.getElementById('typeStreak').textContent = session.streak;

    updateProgress();
}

function checkTypeAnswer() {
    if (typeAnswered || !typeCard) return;

    const input = document.getElementById('typeInput').value.trim().toLowerCase();
    const correct = typeCard.word.toLowerCase();
    typeAnswered = true;

    const key = currentDeck + ':' + typeCard.word;
    if (!progress[key]) progress[key] = { level: 0, lastSeen: 0 };
    progress[key].lastSeen = Date.now();

    const inputEl = document.getElementById('typeInput');
    const feedback = document.getElementById('typeFeedback');

    if (input === correct) {
        inputEl.classList.add('correct');
        feedback.textContent = 'Correct!';
        feedback.className = 'type-feedback correct';
        progress[key].level = Math.min(3, progress[key].level + 1);
        session.correct++;
        session.streak++;
        session.score += 10 + (session.streak * 2);
    } else {
        inputEl.classList.add('incorrect');
        feedback.textContent = 'Incorrect';
        feedback.className = 'type-feedback incorrect';
        document.getElementById('correctAnswer').textContent = 'Answer: ' + typeCard.word;
        document.getElementById('correctAnswer').style.display = 'inline-block';
        progress[key].level = Math.max(0, progress[key].level - 1);
        session.streak = 0;
        session.missed.push(typeCard);
    }

    session.total++;
    inputEl.readOnly = true;
    document.getElementById('nextBtn').style.display = 'inline-flex';
    document.getElementById('typeScore').textContent = session.score;
    document.getElementById('typeStreak').textContent = session.streak;

    localStorage.setItem('vocabProgress', JSON.stringify(progress));
}

function nextTypeCard() {
    cardIndex++;
    showTypeCard();
}

document.getElementById('typeInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
        if (!typeAnswered) checkTypeAnswer();
        else nextTypeCard();
    }
});

// ===== Deck Manager =====
let editingDeck = null;

function renderDeckGrid() {
    const grid = document.getElementById('deckGrid');
    let html = '';

    for (const [id, deck] of Object.entries(decks)) {
        html += `
            <div class="deck-card" onclick="openEditor('${id}')">
                <h3>${deck.name}</h3>
                <div class="meta">${deck.words.length} words ¬∑ ${deck.description || ''}</div>
            </div>
        `;
    }

    grid.innerHTML = html;
}

function openEditor(id) {
    editingDeck = id;
    const overlay = document.getElementById('editorOverlay');
    overlay.classList.add('show');

    if (id && decks[id]) {
        document.getElementById('editorTitle').textContent = 'Edit Deck';
        document.getElementById('deckName').value = decks[id].name;
        document.getElementById('deckDesc').value = decks[id].description || '';
        document.getElementById('deleteBtn').style.display = 'block';
        renderWordList(decks[id].words);
    } else {
        document.getElementById('editorTitle').textContent = 'Create New Deck';
        document.getElementById('deckName').value = '';
        document.getElementById('deckDesc').value = '';
        document.getElementById('deleteBtn').style.display = 'none';
        renderWordList([{ word: '', translation: '', definition: '' }]);
    }
}

function closeEditor() {
    document.getElementById('editorOverlay').classList.remove('show');
}

function renderWordList(words) {
    const container = document.getElementById('wordList');
    container.innerHTML = words.map((w, i) => `
        <div class="word-item" data-index="${i}">
            <input type="text" placeholder="Word" value="${w.word || ''}" data-field="word">
            <input type="text" placeholder="Translation" value="${w.translation || ''}" data-field="translation">
            <input type="text" placeholder="Definition" value="${w.definition || ''}" data-field="definition">
            <button class="icon-btn delete-word" style="height:32px; width:32px; border-color:var(--err); color:var(--err);" onclick="removeWordRow(${i})">‚úï</button>
        </div>
    `).join('');
}

function addWordRow() {
    const container = document.getElementById('wordList');
    const idx = container.children.length;
    const div = document.createElement('div');
    div.className = 'word-item';
    div.dataset.index = idx;
    div.innerHTML = `
        <input type="text" placeholder="Word" data-field="word">
        <input type="text" placeholder="Translation" data-field="translation">
        <input type="text" placeholder="Definition" data-field="definition">
        <button class="icon-btn delete-word" style="height:32px; width:32px; border-color:var(--err); color:var(--err);" onclick="removeWordRow(${idx})">‚úï</button>
    `;
    container.appendChild(div);
    div.querySelector('input').focus();
}

function removeWordRow(idx) {
    const items = document.querySelectorAll('#wordList .word-item');
    // In a real app we'd re-index or use IDs, for simplicity we just remove the node
    // Note: this simple logic breaks index references if not careful, but works for immediate visual removal
    // A better way is to rebuild the list from DOM state, but let's just remove the element
    if (items[idx]) items[idx].remove();
}

function getEditorWords() {
    const words = [];
    document.querySelectorAll('#wordList .word-item').forEach(item => {
        const word = item.querySelector('[data-field="word"]').value.trim();
        const translation = item.querySelector('[data-field="translation"]').value.trim();
        const definition = item.querySelector('[data-field="definition"]').value.trim();
        if (word) words.push({ word, translation, definition });
    });
    return words;
}

function saveDeck() {
    const name = document.getElementById('deckName').value.trim();
    const description = document.getElementById('deckDesc').value.trim();
    const words = getEditorWords();

    if (!name) return alert('Please enter a deck name');
    if (words.length === 0) return alert('Please add at least one word');

    const id = editingDeck || 'deck_' + Date.now();
    decks[id] = { name, description, words };

    // In a real app, save to server here.
    
    closeEditor();
    populateDeckSelects();
    renderDeckGrid();
    if (!currentDeck) loadDeck(id);
}

function deleteDeck() {
    if (!editingDeck) return;
    if (!confirm('Delete this deck?')) return;

    delete decks[editingDeck];
    closeEditor();
    populateDeckSelects();
    renderDeckGrid();
    if (currentDeck === editingDeck) {
        currentDeck = Object.keys(decks)[0] || null;
        if (currentDeck) loadDeck(currentDeck);
        else document.getElementById('flashcardArea').style.display = 'none';
    }
}

function exportDeck() {
    const name = document.getElementById('deckName').value.trim() || 'deck';
    const words = getEditorWords();
    const data = { name, words };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name.replace(/\s+/g, '_') + '.json';
    a.click();
}

// ===== Import =====
const importArea = document.getElementById('importArea');
importArea.addEventListener('dragover', e => { e.preventDefault(); importArea.style.borderColor = 'var(--acc)'; });
importArea.addEventListener('dragleave', () => importArea.style.borderColor = 'var(--border)');
importArea.addEventListener('drop', e => {
    e.preventDefault();
    importArea.style.borderColor = 'var(--border)';
    const file = e.dataTransfer.files[0];
    if (file) importFile(file);
});

function handleFileImport(e) {
    const file = e.target.files[0];
    if (file) importFile(file);
}

async function importFile(file) {
    const text = await file.text();
    let data;

    if (file.name.endsWith('.json')) {
        try { data = JSON.parse(text); } catch { return alert('Invalid JSON'); }
    } else {
        // TSV
        const lines = text.trim().split('\n');
        const words = lines.map(line => {
            const [word, translation, definition] = line.split('\t');
            return { word: word?.trim(), translation: translation?.trim(), definition: definition?.trim() };
        }).filter(w => w.word);
        data = { name: file.name.replace(/\.\w+$/, ''), words };
    }

    if (!data.words || !data.words.length) return alert('No words found');

    const id = 'deck_' + Date.now();
    decks[id] = { name: data.name || 'Imported', description: '', words: data.words };

    populateDeckSelects();
    renderDeckGrid();
    loadDeck(id);
    alert(`Imported "${data.name}" with ${data.words.length} words`);
}

// ===== Keyboard =====
document.addEventListener('keydown', e => {
    if (document.querySelector('.overlay.show')) return; // Don't trigger if modal open
    if (document.activeElement.tagName === 'INPUT') return;

    if (currentView === 'flashcard') {
        if (e.code === 'Space') { e.preventDefault(); flipCard(); }
        if (isFlipped && e.key >= '1' && e.key <= '4') rateCard(parseInt(e.key) - 1);
    }
});

// ===== Stats =====
function showStats() {
    const overlay = document.getElementById('statsOverlay');
    overlay.classList.add('show');

    // Load from local history
    const history = JSON.parse(localStorage.getItem('sessionHistory') || '[]');
        
    let totalTotal = 0, totalCorrect = 0, totalS = 0;
    history.forEach(s => {
        totalTotal += s.total;
        totalCorrect += s.correct;
        totalS += (s.score || 0);
    });

    document.getElementById('totalReviewed').textContent = totalTotal;
    document.getElementById('avgAccuracy').textContent = totalTotal ? Math.round((totalCorrect / totalTotal) * 100) + '%' : '0%';
    document.getElementById('totalScore').textContent = totalS;

    // Session History Table
    const tbody = document.getElementById('sessionHistory');
    tbody.innerHTML = history.reverse().slice(0, 10).map(s => {
        const date = new Date(s.timestamp).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        const deckName = decks[s.deck] ? decks[s.deck].name : 'Unknown';
        const acc = s.total ? Math.round((s.correct / s.total) * 100) : 0;
        return `
            <tr>
                <td>${date}</td>
                <td><strong>${deckName}</strong></td>
                <td><span class="mode-badge">${s.mode}</span></td>
                <td style="color: var(--acc); font-weight: 700;">${acc}%</td>
                <td>${s.score || '-'}</td>
            </tr>
        `;
    }).join('');
}

// ===== Init =====
loadDecks();
</script>
</body>
</html>
